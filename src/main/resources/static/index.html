<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laravel Log Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<div id="app">
    <h1>Laravel Log Viewer</h1>

    <!-- Log file path input -->
    <div>
        <label for="logPath">Log File Path:</label>
        <input type="text" id="logPath" v-model="logPath">
        <button @click="loadLogs">Load Logs</button>
    </div>

    <!-- Pagination controls -->
    <div>
        <button @click="previousPage">Previous</button>
        <span>Page {{ currentPage + 1 }}</span>
        <button @click="nextPage">Next</button>
    </div>

    <!-- Log display area -->
    <pre v-if="logs.length > 0">{{ logs.join('\n') }}</pre>
    <p v-else>No logs available.</p>

    <!-- Real-time log stream -->
    <h2>Real-Time Log Stream</h2>
    <pre>{{ streamLogs.join('\n') }}</pre>
</div>

<script>
    new Vue({
        el: '#app',
        data: {
            logPath: '', // Default log path
            logs: [], // Paginated logs (initialized as an empty array)
            streamLogs: [], // Real-time logs
            currentPage: 0, // Current page number
            pageSize: 10, // Number of logs per page
            totalLogs: 0, // Total number of logs
            stompClient: null // WebSocket client
        },
        computed: {
            isLastPage() {
                return (this.currentPage + 1) * this.pageSize >= this.totalLogs;
            }
        },
        methods: {
            // Load logs for the current page
            loadLogs() {
                fetch(`/v2/logs?path=${encodeURIComponent(this.logPath)}&page=${this.currentPage}&size=${this.pageSize}`)
                    .then(response => response.json())
                    .then(data => {
                        // Ensure data is an array
                        this.logs = Array.isArray(data) ? data : [];
                    })
                    .catch(error => {
                        console.error('Error loading logs:', error);
                        this.logs = []; // Fallback to empty array on error
                    });
            },
            // Navigate to the previous page
            previousPage() {
                if (this.currentPage > 0) {
                    this.currentPage--;
                    this.loadLogs();
                }
            },
            // Navigate to the next page
            nextPage() {
                this.currentPage++;
                this.loadLogs();
            },
            // Initialize WebSocket for real-time log streaming
            initWebSocket() {
                const socket = new SockJS('/ws-logs');
                this.stompClient = Stomp.over(socket);

                this.stompClient.connect({}, () => {
                    console.log('Connected to WebSocket');
                    this.stompClient.subscribe('/topic/logs', (message) => {
                        this.streamLogs.push(message.body);
                    });
                });
            }
        },
        mounted() {
            this.loadLogs(); // Load logs on page load
            this.initWebSocket(); // Initialize WebSocket connection
        }
    });
</script>
</body>
</html>